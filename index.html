<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="Permissions-Policy"
        content="accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), usb=(), xr-spatial-tracking=()">

    <script src="https://cesium.com/downloads/cesiumjs/releases/1.115/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.115/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <link rel="stylesheet" href="./css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Fredoka+One&family=Bebas+Neue:wght@400&family=Anton&display=swap"
        rel="stylesheet">
</head>

<body>
    <!-- Splash Screen -->
    <div class="splash-screen" id="splashScreen">
        <!-- Tu logo SVG -->
        <img src="img/Logo.svg" alt="Logo" class="logo">
    </div>
    <script>
        // Funci√≥n para ocultar el splash screen
        function hideSplashScreen() {
            const splashScreen = document.getElementById('splashScreen');
            splashScreen.classList.add('fade-out');

            // Remover completamente el elemento despu√©s de la animaci√≥n
            setTimeout(() => {
                splashScreen.remove();
            }, 800); // 800ms corresponde a la duraci√≥n de la transici√≥n CSS
        }

        // Mostrar splash screen por 2 segundos
        window.addEventListener('load', () => {
            setTimeout(hideSplashScreen, 2000); // 2000ms = 2 segundos
        });

        // Alternativa: Si quieres que inicie inmediatamente sin esperar a que cargue todo
        // setTimeout(hideSplashScreen, 2000);
    </script>

    

    <!-- Overlay con instrucciones de navegaci√≥n -->
    <div class="overlay" id="navigationOverlay">
        <div class="navigation-card">
            <!-- Bot√≥n de cerrar -->
            <button class="close-btn" id="closeBtn">
                <i class="fas fa-times"></i>
            </button>

            <!-- T√≠tulo -->
            <h2 class="title">Instrucciones de navegaci√≥n</h2>

            <!-- Instrucciones para Desktop -->
            <div class="instructions-container">
                <div class="instruction">
                    <img src="img/Clic.svg" alt="Clic sostenido" class="mouse-icon">
                    <div class="instruction-title">Clic sostenido</div>
                    <div class="instruction-subtitle">Desplazarse</div>
                </div>

                <div class="instruction">
                    <img src="img/rueda.svg" alt="Deslizar rueda" class="mouse-icon">
                    <div class="instruction-title">Deslizar rueda</div>
                    <div class="instruction-subtitle">Ajustar zoom</div>
                </div>

                <div class="instruction">
                    <img src="img/scroll.svg" alt="Rueda sostenida" class="mouse-icon">
                    <div class="instruction-title">Rueda sostenida</div>
                    <div class="instruction-subtitle">Cambiar perspectiva</div>
                </div>
            </div>

            <!-- Instrucciones para Mobile -->
            <div class="instructions-container-mobile">
                <div class="instruction-mobile">
                    <img src="img/Clic_hands.svg" alt="Tocar y arrastrar" class="hand-icon">
                    <div class="instruction-title">Tocar y arrastrar</div>
                    <div class="instruction-subtitle">Desplazarse</div>
                </div>

                <div class="instruction-mobile">
                    <img src="img/rueda_hans.svg" alt="Pellizcar" class="hand-icon">
                    <div class="instruction-title">Pellizcar</div>
                    <div class="instruction-subtitle">Ajustar zoom</div>
                </div>

                <div class="instruction-mobile">
                    <img src="img/arrastar_dedo.svg" alt="Arrastrar con dos dedos" class="hand-icon">
                    <div class="instruction-title">Dos dedos</div>
                    <div class="instruction-subtitle">Cambiar perspectiva</div>
                </div>

                <div class="instruction-mobile">
                    <img src="img/tocar_lote.svg" alt="Tocar elemento" class="hand-icon">
                    <div class="instruction-title">Tocar</div>
                    <div class="instruction-subtitle">Seleccionar</div>
                </div>
            </div>

            <!-- Bot√≥n Entendido -->
            <button class="understood-btn" id="understoodBtn">Entendido</button>
        </div>
    </div>

    <script>
        // Referencias a los elementos
        const overlay = document.getElementById('navigationOverlay');
        const closeBtn = document.getElementById('closeBtn');
        const understoodBtn = document.getElementById('understoodBtn');

        // Funci√≥n para cerrar el overlay
        function closeOverlay() {
            overlay.classList.add('fade-out');

            // Remover completamente despu√©s de la animaci√≥n
            setTimeout(() => {
                overlay.remove();
            }, 500); // 500ms corresponde a la duraci√≥n de la transici√≥n
        }

        // Event listeners
        closeBtn.addEventListener('click', closeOverlay);
        understoodBtn.addEventListener('click', closeOverlay);

        // Cerrar tambi√©n si se hace clic fuera de la card (opcional)
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
                closeOverlay();
            }
        });

        // Cerrar con la tecla Escape (opcional)
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeOverlay();
            }
        });
    </script>

    

    <nav class="sidebar-menu">
        <div class="logo-container">
            <img src="img/logo_mikonos.png" alt="Mykonos Residencial Playa">
        </div>

        <div class="menu-container">
            <div class="menu-items">
                <a id="fotos" class="menu-item">
                    <img src="img/icon_fotos.svg" alt="Fotos 360¬∞" class="icon">
                    <span class="text">Fotos 360¬∞</span>
                </a>

                <a id="areas" class="menu-item">
                    <img src="img/icon_areas.svg" alt="√Åreas comunes" class="icon">
                    <span class="text">√Åreas comunes</span>
                </a>

                <a id="lotes" class="menu-item">
                    <img src="img/icon_lotes.svg" alt="Lotes" class="icon">
                    <span class="text">Lotes</span>
                </a>

                <a id="entorno" class="menu-item">
                    <img src="img/icon_entorno.svg" alt="Entorno" class="icon">
                    <span class="text">Entorno</span>
                </a>
            </div>
        </div>
    </nav>

    <!-- Modal para recorrido 360¬∞ -->
    <div class="modal-360-overlay" id="modal360">
        <div class="modal-360-content">
                <button class="modal-360-close" onclick="close360Modal()">√ó</button>
            <div class="modal-360-viewer">
                <div class="loading-spinner"></div>
                <div class="viewer-360-container" id="viewer360">
                    <img class="panorama-image" id="panoramaImg" src="img/360.jpg" alt="Vista panor√°mica 360¬∞"
                        onload="hideLoading()" onerror="handleImageError()">
                </div>
                <div class="viewer-controls">
                    <button class="control-button" onclick="resetView()">‚åÇ Centrar</button>
                    <button class="control-button" onclick="toggleAutoRotate()">üîÑ Auto</button>
                    <button class="control-button" onclick="zoomIn()">‚ûï Zoom</button>
                    <button class="control-button" onclick="zoomOut()">‚ûñ Zoom</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let isDragging = false;
        let startX = 0;
        let currentX = 0;
        let rotation = 0;
        let autoRotate = false;
        let autoRotateInterval;
        let zoomLevel = 1;

        const viewer = document.getElementById('viewer360');
        const panoramaImg = document.getElementById('panoramaImg');

        function open360Modal() {
            document.getElementById('modal360').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function close360Modal() {
            document.getElementById('modal360').classList.remove('active');
            document.body.style.overflow = 'auto';
            stopAutoRotate();
        }

        function hideLoading() {
            const spinner = document.querySelector('.loading-spinner');
            if (spinner) {
                spinner.style.display = 'none';
            }
            setupPanoramaControls();
        }

        function handleImageError() {
            const spinner = document.querySelector('.loading-spinner');
            const viewer = document.getElementById('viewer360');

            if (spinner) {
                spinner.style.display = 'none';
            }

            // Mostrar mensaje de error
            const errorMsg = document.createElement('div');
            errorMsg.style.cssText = `
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                color: #666;
                text-align: center;
                font-size: 16px;
                padding: 20px;
                background: rgba(255,255,255,0.9);
                border-radius: 10px;
                max-width: 300px;
            `;
            errorMsg.innerHTML = `
                <div style="font-size: 48px; margin-bottom: 15px;">üì∑</div>
                <div style="font-weight: bold; margin-bottom: 10px;">Imagen no encontrada</div>
                <div style="font-size: 14px; color: #999;">
                    Aseg√∫rate de que la imagen est√© en:<br>
                    <code style="background: #f0f0f0; padding: 2px 4px; border-radius: 3px;">img/360.jpg</code>
                </div>
            `;
            viewer.appendChild(errorMsg);
        }

        function setupPanoramaControls() {
            viewer.addEventListener('mousedown', startDrag);
            viewer.addEventListener('mousemove', drag);
            viewer.addEventListener('mouseup', endDrag);
            viewer.addEventListener('mouseleave', endDrag);

            // Touch events para m√≥viles
            viewer.addEventListener('touchstart', startDrag);
            viewer.addEventListener('touchmove', drag);
            viewer.addEventListener('touchend', endDrag);
        }

        function startDrag(e) {
            isDragging = true;
            startX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
            currentX = startX;
            stopAutoRotate();
        }

        function drag(e) {
            if (!isDragging) return;

            e.preventDefault();
            const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
            const deltaX = clientX - currentX;
            currentX = clientX;

            rotation += deltaX * 0.5;
            updatePanoramaPosition();
        }

        function endDrag() {
            isDragging = false;
        }

        function updatePanoramaPosition() {
            panoramaImg.style.transform = `translateX(${rotation}px) scale(${zoomLevel})`;
        }

        function resetView() {
            rotation = 0;
            zoomLevel = 1;
            updatePanoramaPosition();
            stopAutoRotate();
        }

        function toggleAutoRotate() {
            if (autoRotate) {
                stopAutoRotate();
            } else {
                startAutoRotate();
            }
        }

        function startAutoRotate() {
            autoRotate = true;
            autoRotateInterval = setInterval(() => {
                rotation -= 1;
                updatePanoramaPosition();
            }, 50);
        }

        function stopAutoRotate() {
            autoRotate = false;
            if (autoRotateInterval) {
                clearInterval(autoRotateInterval);
            }
        }

        function zoomIn() {
            if (zoomLevel < 2) {
                zoomLevel += 0.1;
                updatePanoramaPosition();
            }
        }

        function zoomOut() {
            if (zoomLevel > 0.5) {
                zoomLevel -= 0.1;
                updatePanoramaPosition();
            }
        }

        // Cerrar modal con Escape
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                close360Modal();
            }
        });

        // Cerrar modal al hacer clic fuera del contenido
        document.getElementById('modal360').addEventListener('click', function (e) {
            if (e.target === this) {
                close360Modal();
            }
        });
    </script>
    <div id="cesiumContainer"></div>
    <script src="./js/index.js" type="module"></script>
    </div>

    <!-- Botones del entorno -->
    <div class="entorno-buttons-container" id="entornoButtonsContainer" style="display: none;">
        <div class="entorno-button active">
            <img src="img/icon_entorno.svg" alt="Todos" class="entorno-button-icon">
            <span class="entorno-button-text">Todos</span>
        </div>
        <div class="entorno-button">
            <img src="img/playas.svg" alt="Playas" class="entorno-button-icon">
            <span class="entorno-button-text">Playas</span>
        </div>
        <div class="entorno-button">
            <img src="img/restaurantes.svg" alt="Restaurantes" class="entorno-button-icon">
            <span class="entorno-button-text">Restaurantes</span>
        </div>
        <div class="entorno-button">
            <img src="img/hoteles.svg" alt="Hoteles" class="entorno-button-icon">
            <span class="entorno-button-text">Hoteles</span>
        </div>
        <div class="entorno-button">
            <img src="img/turismo.svg" alt="Turismo" class="entorno-button-icon">
            <span class="entorno-button-text">Turismo</span>
        </div>
        <div class="entorno-button">
            <img src="img/seguridad.svg" alt="Seguridad" class="entorno-button-icon">
            <span class="entorno-button-text">Seguridad</span>
        </div>
    </div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <a class="back-link" href="#" onclick="closeModal(); return false;">
                <i class="fas fa-arrow-left"></i>
                <span>Volver</span>
            </a>
            <div class="modal-header">
                <div class="modal-logo">
                    <img src="img/logo_mikonos.png" alt="Mykonos Residencial Playa" class="logo-image">
                </div>
            </div>

            <div class="modal-content">
                <div class="lot-identification">
                    <div class="lot-box">
                        <span class="lot-text" id="modalLot">Mz. C - Lt. 7</span>
                    </div>
                    <div class="status-badge" id="modalStatus">Disponible</div>
                </div>

                <div class="property-details">
                    <div class="detail-row">
                        <span class="detail-label">Precio</span>
                        <span class="detail-value" id="modalPrice">$ 28,000</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">√Årea</span>
                        <span class="detail-value" id="modalArea">115,00 m¬≤</span>
                    </div>
                </div>

                <div class="separator"></div>

                <div class="boundaries-section">
                    <h3 class="boundaries-title">Colindancias</h3>
                    <div class="boundaries-card">
                        <div class="boundary-item">
                            <div class="boundary-icon">
                                <img src="img/izquierda.svg" alt="Izquierda" class="boundary-icon-svg">
                            </div>
                            <span class="boundary-label">Izquierda</span>
                            <span class="boundary-value" id="modalLeft">12.00ML</span>
                        </div>
                        <div class="boundary-item">
                            <div class="boundary-icon">
                                <img src="img/derecha.svg" alt="Derecha" class="boundary-icon-svg">
                            </div>
                            <span class="boundary-label">Derecha</span>
                            <span class="boundary-value" id="modalRight">12.00ML</span>
                        </div>
                        <div class="boundary-item">
                            <div class="boundary-icon">
                                <img src="img/frente.svg" alt="Frente" class="boundary-icon-svg">
                            </div>
                            <span class="boundary-label">Frente</span>
                            <span class="boundary-value" id="modalFront">12.00ML</span>
                        </div>
                        <div class="boundary-item">
                            <div class="boundary-icon">
                                <img src="img/fondo.svg" alt="Fondo" class="boundary-icon-svg">
                            </div>
                            <span class="boundary-label">Fondo</span>
                            <span class="boundary-value" id="modalBack">12.00ML</span>
                        </div>
                    </div>
                </div>

                <button class="whatsapp-btn">
                    <i class="fa-brands fa-whatsapp"></i>
                    <span>Cotiza tu lote</span>
                </button>
            </div>
        </div>
    </div>
    
    

    

    <div class="bottom-menu-container">
        <!-- Barra de iconos -->
        <div class="icon-toolbar">
            <button id="home" class="icon-button">
                <img src="img/home.svg" alt="Home">
            </button>

            <div class="divider"></div>

            <button id="up" class="icon-button">
                <img src="img/up.svg" alt="Up">
            </button>

            <div class="divider"></div>

            <button id="down" class="icon-button">
                <img src="img/down.svg" alt="Down">
            </button>

            <div class="divider"></div>

            <button id="zoomIn" class="icon-button">
                <img src="img/zoom +.svg" alt="Zoom In">
            </button>

            <div class="divider"></div>

            <button id="zoomOut" class="icon-button">
                <img src="img/zoom -.svg" alt="Zoom Out">
            </button>

            <div class="divider"></div>

            <button id="view3d" class="icon-button">
                <img src="img/3D.svg" alt="3D">
            </button>

            <div class="divider"></div>

            <button id="grid" class="icon-button">
                <img src="img/plot.svg" alt="Plot">
            </button>
        </div>

        <!-- Botones de estado -->
        <div class="status-buttons">
            <button class="status-button disponible">
                <span class="status-indicator"></span>
                Disponible
            </button>

            <button class="status-button reservado">
                <span class="status-indicator"></span>
                Reservado
            </button>

            <button class="status-button vendido">
                <span class="status-indicator"></span>
                Vendido
            </button>
        </div>
    </div>

    <!-- Modal para Ubicaciones -->
    <div class="modal-overlay" id="locationModalOverlay" style="display: none;">
        <div class="modal">
            <div class="modal-content">
                <h1 class="property-title" id="locationModalTitle"></h1>
                <div class="location-image">
                    <img id="locationModalImage" src="" alt="" style="width: 100%; border-radius: 8px; margin: 16px 0;">
                    <button class="expand-image-btn" onclick="expandImage()">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <path d="M4 4h16v16H4V4z" stroke="white" stroke-width="2" />
                            <path d="M9 9l6 6M15 9l-6 6" stroke="white" stroke-width="2" />
                        </svg>
                    </button>
                </div>
                <div class="location-details">
                    <h2 class="location-subtitle">Direcci√≥n:</h2>
                    <p class="location-address" id="locationModalAddress"></p>
                    <div class="info-row">
                        <button class="link-button" id="calculateRouteBtn">
                            ¬øC√≥mo llegar?
                        </button>
                        <div class="time-estimate">
                            <span class="time-icon">‚è±Ô∏è</span>
                            <span id="locationModalTime"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para √Åreas comunes -->
    <div class="common-areas-modal-overlay" id="commonAreasModalOverlay" style="display: none;">
        <div class="common-areas-modal">
            <div class="common-areas-modal-header">
                <div class="common-areas-modal-title">
                    <img src="img/comunidad.svg" alt="Comunidad" class="common-areas-modal-icon">
                    <span>Comunidad</span>
                </div>
            </div>
            <div class="common-areas-modal-content">

                <!-- Comunidad Section -->
                <div class="common-areas-section">
                    <div class="common-areas-grid" id="commonAreasGrid">
                        <!-- Las tarjetas se generar√°n din√°micamente aqu√≠ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Fotos 360¬∞ -->
    <div class="fotos360-modal-overlay" id="fotos360ModalOverlay" style="display: none;">
        <div class="fotos360-modal">
            <button class="fotos360-modal-close" onclick="closeFotos360Modal()">
                <i class="fas fa-times"></i>
            </button>
            <div class="fotos360-modal-content">
                <iframe id="fotos360Iframe" src="" frameborder="0" allowfullscreen
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; xr-spatial-tracking"
                    sandbox="allow-same-origin allow-scripts allow-popups allow-forms"></iframe>
            </div>
        </div>
    </div>

    <!-- Modal para Im√°genes de √Åreas Comunes -->
    <div class="areas-comunes-images-modal-overlay" id="areasComunesImagesModalOverlay" style="display: none;">
        <div class="areas-comunes-images-modal">
            <button class="areas-comunes-images-modal-close" onclick="closeAreasComunesImagesModal()">
                <i class="fas fa-times"></i>
            </button>
            <div class="areas-comunes-images-modal-content">
                <img id="areasComunesImage" src="" alt="Imagen del √°rea com√∫n" />
            </div>
        </div>
    </div>

    <!-- Modal para B√∫squeda de Lotes -->
    <div class="modal-overlay" id="lotSearchModalOverlay" style="display: none;">
        <div class="lot-search-modal">
            <div class="lot-search-header">
                <div class="lot-search-title">
                    <img src="img/busqueda_lotes.svg" alt="B√∫squeda de lotes" class="lot-search-icon">
                    <span>B√∫squeda de lotes</span>
                </div>
            </div>
            
            <div class="lot-search-content">
                <!-- Filtros principales: Precio y √Årea -->
                <div class="filters-container">
                    <div class="filter-section">
                        <label class="filter-label">Precio</label>
                        <div class="range-slider-container">
                            <div class="range-slider price-range-slider">
                                <span class="output outputOne price-output-min"></span>
                                <span class="output outputTwo price-output-max"></span>
                                <span class="full-range"></span>
                                <span class="incl-range"></span>
                                <input name="priceMin" value="0" min="0" max="60000" step="1000" type="range">
                                <input name="priceMax" value="60000" min="0" max="60000" step="1000" type="range">
                            </div>
                        </div>
                    </div>
                    <div class="filter-section">
                        <label class="filter-label">√Årea</label>
                        <div class="range-slider-container">
                            <div class="range-slider area-range-slider">
                                <span class="output outputOne area-output-min"></span>
                                <span class="output outputTwo area-output-max"></span>
                                <span class="full-range"></span>
                                <span class="incl-range"></span>
                                <input name="areaMin" value="90" min="90" max="500" step="1" type="range">
                                <input name="areaMax" value="500" min="90" max="500" step="1" type="range">
                            </div>
                        </div>
                    </div>
                    <div class="clear-filters-container">
                        <button class="clear-filters" onclick="clearFilters()">Limpiar filtros</button>
                    </div>
                </div>

                <!-- Filtros secundarios: Ordenar por y Estado -->
                <div class="filters-secondary">
                    <div class="filter-section">
                        <label class="filter-label">Ordenar por</label>
                        <div class="dropdown-container">
                            <select id="sortSelect" class="sort-dropdown">
                                <option value="area-asc">√Årea: de menor a mayor</option>
                                <option value="area-desc">√Årea: de mayor a menor</option>
                                <option value="price-asc">Precio: de menor a mayor</option>
                                <option value="price-desc">Precio: de mayor a menor</option>
                                <option value="number-asc">N√∫mero: de menor a mayor</option>
                                <option value="number-desc">N√∫mero: de mayor a menor</option>
                            </select>
                        </div>
                    </div>
                    <div class="filter-section">
                        <label class="filter-label">Estado</label>
                        <div class="status-buttons">
                            <button class="status-btn" data-status="vendido">Vendido</button>
                            <button class="status-btn" data-status="reservado">Reservado</button>
                            <button class="status-btn active" data-status="disponible">Disponible</button>
                        </div>
                    </div>
                </div>

                <!-- Resultados -->
                <div class="results-section">
                    <div class="results-count" id="resultsCount">Mostrando (0) lotes</div>
                    <div class="lot-cards-container" id="lotCardsContainer">
                        <!-- Los lotes se cargar√°n din√°micamente aqu√≠ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    

    <script>
        function closeLocationModal() {
            document.getElementById('locationModalOverlay').style.display = 'none';
        }

        function closeCommonAreasModal() {
            document.getElementById('commonAreasModalOverlay').style.display = 'none';

            // Limpiar marcadores de √°reas comunes al cerrar el modal
            if (typeof viewer !== 'undefined' && viewer.entities && viewer.entities.values) {
                const areaEntitiesToRemove = viewer.entities.values.filter(entity =>
                    entity.id && entity.id.startsWith("area_comun_")
                );
                areaEntitiesToRemove.forEach(entity => viewer.entities.remove(entity));
            }
        }

        function openFotos360Modal(kuulaUrl) {
            console.log("Abriendo modal con URL:", kuulaUrl);

            const modal = document.getElementById('fotos360ModalOverlay');
            const iframe = document.getElementById('fotos360Iframe');

            console.log("Modal encontrado:", modal);
            console.log("Iframe encontrado:", iframe);

            if (modal && iframe) {
                // Configurar el iframe
                iframe.src = kuulaUrl;

                // Mostrar el modal
                modal.style.display = 'flex';

                // Forzar reflow para que la animaci√≥n funcione
                modal.offsetHeight;

                // Agregar la clase show para activar la animaci√≥n
                modal.classList.add('show');

                console.log("Modal abierto correctamente");
            } else {
                console.error("No se encontraron los elementos del modal");
            }
        }

        function closeFotos360Modal() {
            const modal = document.getElementById('fotos360ModalOverlay');
            const iframe = document.getElementById('fotos360Iframe');

            if (modal && iframe) {
                // Remover la clase show para iniciar la animaci√≥n de cierre
                modal.classList.remove('show');

                // Esperar a que termine la animaci√≥n antes de ocultar
                setTimeout(() => {
                    modal.style.display = 'none';
                    iframe.src = ''; // Limpiar el iframe
                }, 400); // 400ms para que coincida con la duraci√≥n de la animaci√≥n
            }
        }

        function openAreasComunesImagesModal(imageUrl) {
            console.log("Abriendo modal de imagen con URL:", imageUrl);

            const modal = document.getElementById('areasComunesImagesModalOverlay');
            const img = document.getElementById('areasComunesImage');

            console.log("Modal encontrado:", modal);
            console.log("Imagen encontrada:", img);

            if (modal && img) {
                // Configurar la imagen
                img.src = imageUrl;

                // Mostrar el modal
                modal.style.display = 'flex';

                // Forzar reflow para que la animaci√≥n funcione
                modal.offsetHeight;

                // Agregar la clase show para activar la animaci√≥n
                modal.classList.add('show');

                console.log("Modal de imagen abierto correctamente");
            } else {
                console.error("No se encontraron los elementos del modal de imagen");
            }
        }

        function closeAreasComunesImagesModal() {
            const modal = document.getElementById('areasComunesImagesModalOverlay');
            const img = document.getElementById('areasComunesImage');

            if (modal && img) {
                // Remover la clase show para iniciar la animaci√≥n de cierre
                modal.classList.remove('show');

                // Esperar a que termine la animaci√≥n antes de ocultar
                setTimeout(() => {
                    modal.style.display = 'none';
                    img.src = ''; // Limpiar la imagen
                }, 400); // 400ms para que coincida con la duraci√≥n de la animaci√≥n
            }
        }

        function closeLotSearchModal() {
            document.getElementById('lotSearchModalOverlay').style.display = 'none';
        }

        function openLotSearchModal() {
            document.getElementById('lotSearchModalOverlay').style.display = 'flex';
            loadLotData();
        }

        function clearFilters() {
            // Reset price sliders
            const priceMinSlider = document.querySelector('input[name="priceMin"]');
            const priceMaxSlider = document.querySelector('input[name="priceMax"]');
            if (priceMinSlider && priceMaxSlider) {
                // Reset to initial values
                priceMinSlider.value = 0;
                priceMaxSlider.value = 60000; // Default max value
                updatePriceLabels();
            }
            
            // Reset area sliders
            const areaMinSlider = document.querySelector('input[name="areaMin"]');
            const areaMaxSlider = document.querySelector('input[name="areaMax"]');
            if (areaMinSlider && areaMaxSlider) {
                // Reset to initial values
                areaMinSlider.value = 90;
                areaMaxSlider.value = 500; // Default max value
                updateAreaLabels();
            }
            
            // Reset amenity buttons
            document.querySelectorAll('.amenity-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.amenity-btn[data-amenity="juegos"]').classList.add('active');
            
            // Reset status buttons
            document.querySelectorAll('.status-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.status-btn[data-status="disponible"]').classList.add('active');
            
            // Reset sort dropdown
            document.getElementById('sortSelect').value = 'area-asc';
            
            // Reload data immediately
            loadLotData();
        }

        // Funci√≥n para actualizar sliders de rango dual
        function updateRangeSlider(sliderContainer, minInput, maxInput, minOutput, maxOutput, inclRange, formatValue) {
            const minValue = parseInt(minInput.value);
            const maxValue = parseInt(maxInput.value);
            const maxRange = parseInt(minInput.getAttribute('max'));
            const minRange = parseInt(minInput.getAttribute('min'));
            
            // Actualizar outputs (solo el contenido, no la posici√≥n)
            minOutput.innerHTML = formatValue(minValue);
            maxOutput.innerHTML = formatValue(maxValue);
            
            // Actualizar rango incluido
            if (minValue > maxValue) {
                inclRange.style.width = ((minValue - maxValue) / (maxRange - minRange)) * 100 + '%';
                inclRange.style.left = ((maxValue - minRange) / (maxRange - minRange)) * 100 + '%';
            } else {
                inclRange.style.width = ((maxValue - minValue) / (maxRange - minRange)) * 100 + '%';
                inclRange.style.left = ((minValue - minRange) / (maxRange - minRange)) * 100 + '%';
            }
        }

        function updatePriceLabels() {
            const priceMin = document.querySelector('input[name="priceMin"]');
            const priceMax = document.querySelector('input[name="priceMax"]');
            const priceOutputMin = document.querySelector('.price-output-min');
            const priceOutputMax = document.querySelector('.price-output-max');
            const priceInclRange = document.querySelector('.price-range-slider .incl-range');
            
            if (priceMin && priceMax && priceOutputMin && priceOutputMax && priceInclRange) {
                updateRangeSlider(
                    '.price-range-slider',
                    priceMin,
                    priceMax,
                    priceOutputMin,
                    priceOutputMax,
                    priceInclRange,
                    (value) => `$${parseInt(value).toLocaleString()}`
                );
            }
        }

        function updateAreaLabels() {
            const areaMin = document.querySelector('input[name="areaMin"]');
            const areaMax = document.querySelector('input[name="areaMax"]');
            const areaOutputMin = document.querySelector('.area-output-min');
            const areaOutputMax = document.querySelector('.area-output-max');
            const areaInclRange = document.querySelector('.area-range-slider .incl-range');
            
            if (areaMin && areaMax && areaOutputMin && areaOutputMax && areaInclRange) {
                updateRangeSlider(
                    '.area-range-slider',
                    areaMin,
                    areaMax,
                    areaOutputMin,
                    areaOutputMax,
                    areaInclRange,
                    (value) => `${parseInt(value)} m¬≤`
                );
            }
        }

        async function loadLotData() {
            // Construir lista de lotes desde terrenos.geojson
            let lots = [];
            let maxPrice = 0;
            let maxArea = 0;
            try {
                const resp = await fetch('./data/terrenos.geojson');
                const gj = await resp.json();
                const feats = (gj && gj.features) ? gj.features : [];
                lots = feats
                    .filter(f => f && f.properties)
                    .filter(f => {
                        const p = f.properties || {};
                        // Excluir jardines y lotes sin n√∫mero v√°lido
                        const number = p.number || '';
                        const lote = p.lote || '';
                        return number !== 'Jard√≠n' && (lote !== '' || (number !== '' && !isNaN(parseInt(number))));
                    })
                    .map((f, idx) => {
                        const p = f.properties || {};
                        // Normalizar √°rea (ya viene como n√∫mero o string num√©rico en nuevo esquema)
                        let areaNum = 0;
                        if (typeof p.area === 'string') {
                            areaNum = parseFloat(p.area.replace(',', '.')) || 0;
                        } else if (typeof p.area === 'number') {
                            areaNum = p.area;
                        }
                        // Precio
                        let precioNum = 0;
                        if (typeof p.precio === 'string') {
                            precioNum = parseFloat(p.precio.replace(',', '.')) || 0;
                        } else if (typeof p.precio === 'number') {
                            precioNum = p.precio;
                        }
                        
                        // Calcular precio m√°ximo
                        if (precioNum > maxPrice) {
                            maxPrice = precioNum;
                        }
                        
                        // Calcular √°rea m√°xima
                        if (areaNum > maxArea) {
                            maxArea = areaNum;
                        }
                        
                        const estado = p.estado || 'disponible';
                        const manzana = p.manzana || '';
                        const lote = p.lote || '';
                        return {
                            id: p.direccion || `lote-${idx}`,
                            number: p.direccion || (manzana || lote ? `Mz. ${manzana} - Lote ${lote}` : (p.number || `Lote ${idx + 1}`)),
                            price: precioNum,
                            area: areaNum,
                            status: String(estado).toLowerCase()
                        };
                    });
                
                // Actualizar los sliders de precio con el valor real (solo si es la primera carga)
                const priceMinSlider = document.querySelector('input[name="priceMin"]');
                const priceMaxSlider = document.querySelector('input[name="priceMax"]');
                if (priceMinSlider && priceMaxSlider && maxPrice > 0) {
                    priceMinSlider.max = maxPrice;
                    priceMaxSlider.max = maxPrice;
                    // Solo establecer los valores si no se han tocado los sliders
                    if (!priceMinSlider.getAttribute('data-initial-value')) {
                        priceMinSlider.value = 0;
                        priceMaxSlider.value = maxPrice;
                        priceMinSlider.setAttribute('data-initial-value', 0);
                        priceMaxSlider.setAttribute('data-initial-value', maxPrice);
                    }
                    updatePriceLabels();
                }
                
                // Actualizar los sliders de √°rea con el valor real (solo si es la primera carga)
                const areaMinSlider = document.querySelector('input[name="areaMin"]');
                const areaMaxSlider = document.querySelector('input[name="areaMax"]');
                if (areaMinSlider && areaMaxSlider && maxArea > 0) {
                    areaMinSlider.max = Math.ceil(maxArea);
                    areaMaxSlider.max = Math.ceil(maxArea);
                    // Solo establecer los valores si no se han tocado los sliders
                    if (!areaMinSlider.getAttribute('data-initial-value')) {
                        areaMinSlider.value = 90;
                        areaMaxSlider.value = Math.ceil(maxArea);
                        areaMinSlider.setAttribute('data-initial-value', 90);
                        areaMaxSlider.setAttribute('data-initial-value', Math.ceil(maxArea));
                    }
                    updateAreaLabels();
                }
            } catch (e) {
                console.error('No se pudo cargar terrenos.geojson', e);
            }

            // Aplicar filtros
            const filteredLots = applyFilters(lots);
            
            // Apply sorting
            const sortedLots = applySorting(filteredLots);
            
            // Update results count
            document.getElementById('resultsCount').textContent = `Mostrando (${sortedLots.length}) lotes`;
            
            // Render lot cards
            renderLotCards(sortedLots);
        }

        function applyFilters(lots) {
            const priceMin = parseInt(document.querySelector('input[name="priceMin"]').value);
            const priceMax = parseInt(document.querySelector('input[name="priceMax"]').value);
            const areaMin = parseInt(document.querySelector('input[name="areaMin"]').value);
            const areaMax = parseInt(document.querySelector('input[name="areaMax"]').value);
            
            const selectedStatus = Array.from(document.querySelectorAll('.status-btn.active'))
                .map(btn => btn.getAttribute('data-status'));

            return lots.filter(lot => {
                // Price filter - rango de precio
                if (lot.price < priceMin || lot.price > priceMax) return false;
                
                // Area filter - rango de √°rea
                if (lot.area < areaMin || lot.area > areaMax) return false;
                
                // Status filter
                if (!selectedStatus.includes(lot.status)) return false;
                
                return true;
            });
        }

        function applySorting(lots) {
            const sortSelect = document.getElementById('sortSelect');
            const sortValue = sortSelect ? sortSelect.value : 'area-asc';
            
            return lots.sort((a, b) => {
                switch (sortValue) {
                    case 'area-asc':
                        return a.area - b.area;
                    case 'area-desc':
                        return b.area - a.area;
                    case 'price-asc':
                        return a.price - b.price;
                    case 'price-desc':
                        return b.price - a.price;
                    case 'number-asc':
                        const numA = parseInt(a.number) || 0;
                        const numB = parseInt(b.number) || 0;
                        return numA - numB;
                    case 'number-desc':
                        const numA_desc = parseInt(a.number) || 0;
                        const numB_desc = parseInt(b.number) || 0;
                        return numB_desc - numA_desc;
                    default:
                        return 0;
                }
            });
        }

        function renderLotCards(lots) {
            const container = document.getElementById('lotCardsContainer');
            container.innerHTML = '';

            lots.forEach(lot => {
                const card = document.createElement('div');
                card.className = 'lot-card';
                card.innerHTML = `
                    <div class="lot-card-header">${lot.number}</div>
                    <div class="lot-card-separator"></div>
                    <div class="lot-card-status">${lot.status.charAt(0).toUpperCase() + lot.status.slice(1)}</div>
                    <div class="lot-card-details">
                        <span class="lot-card-label">Precio</span>
                        <span class="lot-card-value">$ ${lot.price.toLocaleString()}</span>
                    </div>
                    <div class="lot-card-details">
                        <span class="lot-card-label">√Årea</span>
                        <span class="lot-card-value">${lot.area.toFixed(2)} m¬≤</span>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function viewLotDetails(lotId) {
            // This would open the lot details modal or navigate to lot details
            console.log('Viewing lot details for:', lotId);
            // For now, just close the search modal
            closeLotSearchModal();
        }

        // Nueva funci√≥n para limpiar todos los modales
        function cleanupAll() {
            // Cerrar todos los modales
            document.getElementById('commonAreasModalOverlay').style.display = 'none';
            document.getElementById('locationModalOverlay').style.display = 'none';
            document.getElementById('modalOverlay').style.display = 'none';
            document.getElementById('lotSearchModalOverlay').style.display = 'none';

            // Notificar al viewer que el modal se cerr√≥ (para limpiar selecciones)
            if (window.cesiumOnModalClosed) {
                try { window.cesiumOnModalClosed(); } catch (e) { /* noop */ }
            }

            // Limpiar selecci√≥n del pol√≠gono si existe
            if (window.cesiumClearSelection) {
                try { window.cesiumClearSelection(); } catch (e) { /* noop */ }
            }
        }

        // Funci√≥n para cerrar todos los modales excepto uno espec√≠fico
        function closeAllModalsExcept(exceptModalId) {
            const allModals = [
                'commonAreasModalOverlay',
                'locationModalOverlay', 
                'modalOverlay',
                'lotSearchModalOverlay'
            ];
            
            allModals.forEach(modalId => {
                if (modalId !== exceptModalId) {
                    const modal = document.getElementById(modalId);
                    if (modal) {
                        modal.style.display = 'none';
                    }
                }
            });
        }

        // Exponer las funciones al objeto window para que puedan ser llamadas desde index.js
        window.cleanupAll = cleanupAll;
        window.closeAllModalsExcept = closeAllModalsExcept;
        window.closeAllModals = closeAllModals;

        function closeModal() {
            document.querySelector('.modal-overlay').style.display = 'none';
            // Limpiar selecci√≥n del pol√≠gono si existe
            if (window.cesiumClearSelection) {
                try { window.cesiumClearSelection(); } catch (e) { /* noop */ }
            }
            // Notificar cierre para suprimir hover moment√°neo
            if (window.cesiumOnModalClosed) {
                try { window.cesiumOnModalClosed(); } catch (e) { /* noop */ }
            }
        }

        function closeAllModals() {
            // Cerrar modal principal de propiedades
            const mainModal = document.getElementById('modalOverlay');
            if (mainModal) mainModal.style.display = 'none';
            
            // Cerrar modal 360
            const modal360 = document.getElementById('modal360');
            if (modal360) modal360.style.display = 'none';
            
            // Cerrar modal de ubicaciones
            const locationModal = document.getElementById('locationModalOverlay');
            if (locationModal) locationModal.style.display = 'none';
            
            // Cerrar modal de √°reas comunes
            const commonAreasModal = document.getElementById('commonAreasModalOverlay');
            if (commonAreasModal) commonAreasModal.style.display = 'none';
            
            // Cerrar modal de b√∫squeda de lotes
            const lotSearchModal = document.getElementById('lotSearchModalOverlay');
            if (lotSearchModal) lotSearchModal.style.display = 'none';
            
            // Limpiar selecci√≥n del pol√≠gono si existe
            if (window.cesiumClearSelection) {
                try { window.cesiumClearSelection(); } catch (e) { /* noop */ }
            }
            // Notificar cierre para suprimir hover moment√°neo
            if (window.cesiumOnModalClosed) {
                try { window.cesiumOnModalClosed(); } catch (e) { /* noop */ }
            }
        }


        // Cerrar con tecla Escape
        document.addEventListener('keydown', function (event) {
            if (event.key === 'Escape') {
                closeAllModals();
            }
        });

        // Event listeners para los iconos de la barra de herramientas (sin cerrar modales)
        document.addEventListener('DOMContentLoaded', function () {
            // Obtener todos los iconos de la barra de herramientas
            const toolbarIcons = document.querySelectorAll('.icon-toolbar .icon-button');
            
            // Los botones de la barra de herramientas ya tienen sus propios event listeners
            // No necesitamos cerrar modales aqu√≠
        });

        // Event listeners for lot search modal
        document.addEventListener('DOMContentLoaded', function () {
            // Price sliders (min and max)
            const priceMin = document.querySelector('input[name="priceMin"]');
            const priceMax = document.querySelector('input[name="priceMax"]');
            if (priceMin && priceMax) {
                // Funci√≥n para manejar los sliders de precio
                [priceMin, priceMax].forEach(slider => {
                    slider.addEventListener('input', function () {
                        updatePriceLabels();
                        loadLotData();
                    });
                    slider.addEventListener('mouseup', function() {
                        this.blur();
                    });
                    slider.addEventListener('mousedown', function () {
                        updatePriceLabels();
                    });
                });
                // Inicializar los sliders
                updatePriceLabels();
            }

            // Area sliders (min and max)
            const areaMin = document.querySelector('input[name="areaMin"]');
            const areaMax = document.querySelector('input[name="areaMax"]');
            if (areaMin && areaMax) {
                // Funci√≥n para manejar los sliders de √°rea
                [areaMin, areaMax].forEach(slider => {
                    slider.addEventListener('input', function () {
                        updateAreaLabels();
                        loadLotData();
                    });
                    slider.addEventListener('mouseup', function() {
                        this.blur();
                    });
                    slider.addEventListener('mousedown', function () {
                        updateAreaLabels();
                    });
                });
                // Inicializar los sliders
                updateAreaLabels();
            }

            // Status buttons
            document.querySelectorAll('.status-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    // Remove active from all status buttons
                    document.querySelectorAll('.status-btn').forEach(b => b.classList.remove('active'));
                    // Add active to clicked button
                    this.classList.add('active');
                    loadLotData();
                });
            });

            // Sort dropdown
            const sortSelect = document.getElementById('sortSelect');
            if (sortSelect) {
                sortSelect.addEventListener('change', function () {
                    loadLotData();
                });
            }

            // Connect lot button to open modal
            const lotButton = document.getElementById('lotes');
            if (lotButton) {
                lotButton.addEventListener('click', function () {
                    openLotSearchModal();
                });
            }
        });

        // Funciones para manejar los botones del entorno
        function showEntornoButtons() {
            const container = document.getElementById('entornoButtonsContainer');
            if (container) {
                container.style.display = 'flex';
            }
        }

        function hideEntornoButtons() {
            const container = document.getElementById('entornoButtonsContainer');
            if (container) {
                container.style.display = 'none';
            }
        }

        // Exponer las funciones globalmente para que puedan ser llamadas desde index.js
        window.showEntornoButtons = showEntornoButtons;
        window.hideEntornoButtons = hideEntornoButtons;
    </script>
</body>

</html>